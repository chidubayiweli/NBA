--NBA players with the longest streak of 20 point per game seasons

With last_season_stat AS (
SELECT season, 
      player, 
      pts_per_game, 
      LAG(pts_per_game, 1) OVER (PARTITION BY player ORDER BY season) AS pts_last_season
FROM `NBA.Player` 
),
pts_avg AS (
SELECT *, CASE WHEN pts_per_game >= 20 AND pts_last_season >= 20 THEN 0 ELSE 1 END as pts_avg_over_20
FROM last_season_stat 
),
pts_streak AS (
SELECT *, SUM (pts_avg_over_20) OVER (PARTITION BY player ORDER BY season) AS streak
FROM pts_avg
)
SELECT player, COUNT(CASE WHEN pts_per_game >= 20 THEN 1 END) as no_of_consecutive_seasons, MAX(season) as last_season, MIN(season) as first_season
FROM pts_streak
GROUP BY player, streak
ORDER BY no_of_consecutive_seasons DESC

